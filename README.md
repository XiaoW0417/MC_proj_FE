# Excel Add-in 项目说明

## 项目简介

本项目基于 **Node.js** 和 **Yeoman Office Add-in Generator (yo)** 搭建，完成了一个用于 Microsoft Excel 的 Add-in 插件。该插件实现了三个核心功能，主要针对 Excel 表格中的销售数据进行交互式操作，包括排序、绘制散点图和插入利润列。前后端分离，前端运行在端口 **3000**，后端服务监听端口 **3001**，通过 REST API 实现与前端的通信。

---

## 技术栈

### 前端

- **HTML5 + CSS3 + JavaScript**  
  页面采用标准的Web技术实现，使用纯 CSS 控制布局和样式，包含圆角、固定底部对话框等 UI 设计。  
- **Office JavaScript API (Office.js)**  
  使用官方提供的 Excel JavaScript API 操作 Excel Workbook，包括读取表格、修改数据、插入图表等，确保操作真实反映在 Excel 中。  
- **Fetch API**  
  前端通过 fetch 与本地后端服务通信，发送用户指令并获取解析结果和执行动作。  
- **异步函数 (async/await)**  
  保证异步调用的代码简洁、逻辑清晰。  
- **事件绑定**  
  监听用户输入框和按钮点击，实现人机交互。  

### 后端

- **Node.js + Express**  
  作为后端服务框架，监听来自前端的请求，进行自然语言指令的解析和业务逻辑判断。  
- **RESTful API**  
  提供 `/analyze` 接口，接收用户的消息（JSON格式），返回对应的操作指令和响应描述。  
- **端口配置**  
  后端监听端口为 3001，支持跨域访问（在开发环境），前端运行于 3000 端口。  

---

## 项目结构

excel-chat文件下的核心文件结构如下：
```
├── src
│ ├── taskpane.html # 前端HTML页面
│ ├── taskpane.css # 前端样式文件
│ ├── taskpane.js # 前端主逻辑，含聊天交互、Excel API调用
├── server
│ └── index.js # 后端Express服务器，处理请求和响应
├── package.json # Node.js依赖管理
└── manifest.xml # Excel Add-in清单文件，定义插件配置
```

## 功能实现细节

### 1. 按销售额降序排序表格

- **用户界面**：Add-in 界面渲染当前表格内容的预览，展示排序后的数据。  
- **交互按钮**：“应用操作”按钮，点击后调用 Excel API 对当前 Excel 表格应用排序。  
- **实现方式**：调用 `table.sort.apply([{ key: salesIndex, ascending: false }])` 对表格内的 "Sales" 列进行降序排序。  
- **同步反馈**：排序完成后弹窗提示用户“排序已应用到Excel表！”。  

### 2. 创建销售额与成本的散点图

- **用户界面**：Add-in 界面展示散点图数据的预览（表格形式，横坐标Sales，纵坐标Costs）。  
- **交互按钮**：“插入”按钮，点击后调用 Excel JavaScript API 在工作表内插入真实的 Excel 散点图（非图片）。  
- **实现方式**：  
  - 读取表中 Sales 和 Costs 两列，做数据清洗（去除 $、逗号等非数字符号，保证数据类型正确）。  
  - 创建隐藏的临时工作表，将清洗后的数据写入临时表格，确保图表引用数值。  
  - 在当前工作表插入散点图，X轴为Sales，Y轴为Costs，设置图表标题、位置和图例。  
- **技术要点**：  
  - 结构化数据写入  
  - 图表系列动态添加与删除占位系列  
  - 隐藏临时数据工作表以保持图表引用稳定  
- **同步反馈**：插入成功后弹窗提示“散点图已插入到Excel！”。  

### 3. 插入利润列（未完全实现）

- **设计目标**：在表格最右侧新增“Profits”列，利润通过公式 `=[@Sales]-[@Costs]` 自动计算。  
- **用户界面**：Add-in 显示插入的公式信息，并有“插入公式”按钮。  
- **实现方式**：  
  - 判断表格中是否存在 Profits 列，避免重复添加。  
  - 新增 Profits 列后，一次性将结构化公式赋值给整列。  
  - 若结构化公式写入失败，则退回读取 Sales 和 Costs 数值，计算差值后写入列中。  
- **目前状态**：部分场景下代码存在行列维度不匹配问题，尚未完善，需要进一步调试和健壮性提升。  

---

## 项目完成度与未来工作

- **完成度**：  
  - 排序和散点图功能已完整实现，稳定运行且符合业务需求。  
  - 插入利润列功能已接近完成，代码具备自动回退机制，但存在边界异常需要修复。  

- **未来优化方向**：  
  - 完善利润列插入功能，确保结构化公式和数值填充均不报错。  
  - 丰富前端交互体验，如表格分页、图表样式自定义。  
  - 增加更多Excel数据处理及可视化功能，提升插件实用性。  

---

## 项目亮点

- 充分利用 Office.js 提供的 Excel JavaScript API，实现深度的Excel数据操作和图表插入。  
- 采用现代前后端分离架构，保证扩展性和维护便利。  
- 精心设计的UI体验，保证聊天交互自然流畅，功能按钮直观。  
- 异步编程实践，保证插件响应及时且无卡顿。  

---

## 运行与调试

- 启动后端服务器：

```bash
cd server
npm install
node index.js
```
启动前端开发服务器：


## 总结
##  作者信息

-  作者：WangJun
-  联系方式：wangjun1704@bjfu.edu.cn

---

> 若您觉得本项目有帮助，欢迎 ⭐ ！